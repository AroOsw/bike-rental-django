<div id="chat-widget-container" class="fixed-bottom p-3 m-3" style="left: auto; z-index: 1050;" data-bs-theme="dark">

    <button id="chat-toggle-btn" class="btn btn-success rounded-circle shadow-lg" style="width: 80px; height: 80px;">
        <i class="bi bi-chat-dots"></i></button>

    <div id="chat-window" class="card shadow-lg d-none"
         style="width: 350px; position: absolute; bottom: 80px; right: 0;">
        <div class="card-header bg-wildwheel text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">WildWheel Assistant</h5>
            <button id="chat-close-btn" class="btn-close btn-close-white" aria-label="Close"></button>
        </div>

        <div id="chat-messages" class="card-body overflow-auto" style="height: 400px; background-color: #212529;"></div>
        {{ chat_history|json_script:"chat-history-data" }}


        <div class="card-footer border-top-0 bg-wildwheel">
            <div class="input-group">
                {% if user.is_authenticated %}
                    <input type="text" id="chat-input" class="form-control" placeholder="Type your question..."
                           aria-label="User question">
                    <button id="chat-send-btn" class="btn btn-ai-bot" type="button">
                        Send
                    </button>
                {% else %}
                    <input type="text" id="chat-input" class="form-control"
                           placeholder="Please Log in to chat with assistant" aria-label="User question">
                {% endif %}
            </div>
        </div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {

        const chatWindow = document.getElementById('chat-window');
        const toggleBtn = document.getElementById('chat-toggle-btn');
        const closeBtn = document.getElementById('chat-close-btn');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('chat-send-btn');
        const messagesArea = document.getElementById('chat-messages');

        toggleBtn.onclick = () => {
            chatWindow.classList.remove('d-none');
            toggleBtn.classList.add('d-none');

            setTimeout(() => {
                messagesArea.scrollTop = messagesArea.scrollHeight;
            }, 50);
        };

        closeBtn.onclick = () => {
            chatWindow.classList.add('d-none');
            toggleBtn.classList.remove('d-none');
        };

        let typingIndicator = null;

        function showTypingIndicator() {
            const msgDiv = document.createElement('div');
            msgDiv.id = 'typing-indicator-wrapper';
            msgDiv.className = 'mb-2 text-start';

            const bubble = document.createElement('div');
            bubble.className = 'd-inline-block bg-secondary p-2 rounded-3 shadow-sm typing-dots';

            bubble.innerHTML = '<span></span><span></span><span></span>';

            msgDiv.appendChild(bubble);
            messagesArea.appendChild(msgDiv);
            messagesArea.scrollTop = messagesArea.scrollHeight;

            typingIndicator = msgDiv;
        }

        function removeTypingIndicator() {
            if (typingIndicator) {
                typingIndicator.remove();
                typingIndicator = null;
            }
        }

        function appendMessage(text, sender) {
            const msgDiv = document.createElement('div');
            msgDiv.className = `mb-2 text-${sender === 'user' ? 'end' : 'start'}`;

            const bubble = document.createElement('div');

            bubble.className = `badge p-2 text-wrap shadow-sm ${
                sender === 'user' ? 'bg-wildwheel' : 'bg-secondary'
            }`;

            bubble.style.maxWidth = '80%';
            bubble.style.textAlign = 'left';
            bubble.style.fontWeight = '600';
            bubble.style.fontSize = '0.6rem';
            bubble.style.whiteSpace = 'normal';

            if (sender === 'bot' || sender === 'assistant') {
                bubble.innerHTML = marked.parse(text);

                const lists = bubble.querySelectorAll('ul, ol');
                lists.forEach(l => {
                    l.style.textAlign = 'left';
                    l.style.paddingLeft = '1.5rem';
                    l.style.margin = '10px 0';
                });
            } else {
                bubble.textContent = text;
            }

            msgDiv.appendChild(bubble);
            messagesArea.appendChild(msgDiv);
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }

        try {
            const historyDataElement = document.getElementById('chat-history-data');
            if (historyDataElement) {

                const historyRaw = JSON.parse(historyDataElement.textContent);
                const history = typeof historyRaw === 'string' ? JSON.parse(historyRaw) : historyRaw;

                if (!history || history.length === 0) {
                    appendMessage("Hi! I'm WildWheel AI Chatbot. How can I help you?", "bot");
                } else {
                    history.forEach(msg => {
                        const role = (msg.role === 'assistant' || msg.role === 'bot') ? 'bot' : 'user';
                        appendMessage(msg.content, role);
                    });
                }
            }
        } catch (e) {
            console.error("History loading error:", e);
            appendMessage("Hi! I'm WildWheel AI Chatbot. How can I help you?", "bot");
        }

        messagesArea.scrollTop = messagesArea.scrollHeight;

        async function sendMessage() {
            const text = chatInput.value.trim();
            if (!text) return;

            appendMessage(text, 'user');
            chatInput.value = '';

            showTypingIndicator();

            try {
                const response = await fetch('/ai-bot/ask/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({message: text})
                });

                removeTypingIndicator();

                if (!response.ok) throw new Error('Server error');

                const data = await response.json();
                if (data.reply) {
                    appendMessage(data.reply, 'bot');
                } else {
                    appendMessage("I received empty answer.", 'bot');
                }
            } catch (error) {
                removeTypingIndicator();
                console.error("Error fetch:", error);
                appendMessage("Connection error. Check console (F12).", 'bot');
            }
        }

        sendBtn.onclick = sendMessage;
        chatInput.onkeypress = (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendMessage();
            }
        };

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    })
    ;
</script>